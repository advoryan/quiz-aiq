<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Exclusive Offer — Unlock Your Reward</title>
    <meta name="description" content="Exclusive Offer - Claim your reward" />

  <!-- Bootstrap 5 (latest full) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { important: true, theme: { extend: { colors: { primary: '#2563eb' } } } };
    </script>
    <style>
      /* autocomplete suggestion styles */
      .address-autocomplete { position: relative; }
      #suggestions { position: absolute; left: 0; right: 0; top: calc(100% + 6px); background: white; border: 1px solid #e6e6e6; border-radius: 8px; max-height: 220px; overflow:auto; padding:6px; z-index:9999; display:none; }
      .autocomplete-suggestion { padding:8px 10px; cursor:pointer; border-radius:6px; font-size:14px; color:#0f172a; }
      .autocomplete-suggestion:hover { background:#eef2ff; }
      .autocomplete-suggestion small { display:block; color:#64748b; font-size:12px; }
    </style>

    <style>
      /* fix tailwind and bootstrap styles collision */
      @layer base {
        h1, h2, h3, h4, h5, h6 {
          @apply font-bold;
        }
      }
      .pt-1 { padding-top: 0.25rem; }
      .pb-1 { padding-bottom: 0.25rem; }
      .pl-1 { padding-left: 0.25rem; }
      .pr-1 { padding-right: 0.25rem; }
      .px-1 { padding-left: 0.25rem; padding-right: 0.25rem; }     

    </style>

    <!-- Dynamic lightweight polyfill loader (avoids polyfill.io dependency) -->
    <script>
    (function(){
      if(!document.head) return;
      const need = { core:false, fetch:false, io:false, ro:false };
      if(!window.Promise || !window.Symbol || !Object.assign || !Array.prototype.flat || !window.Map || !window.Set) need.core = true;
      if(!('fetch' in window) || !('AbortController' in window)) need.fetch = true;
      if(!('IntersectionObserver' in window)) need.io = true;
      if(!('ResizeObserver' in window)) need.ro = true;
      function add(src){ const s=document.createElement('script'); s.src=src; s.defer=false; s.crossOrigin='anonymous'; document.head.appendChild(s); }
      if(need.core) add('https://cdn.jsdelivr.net/npm/core-js-bundle@3.38.0/minified.js');
      if(need.fetch) add('https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.20/dist/fetch.umd.min.js');
      if(need.io) add('https://cdn.jsdelivr.net/npm/intersection-observer@0.12.2/intersection-observer.js');
      if(need.ro) add('https://cdn.jsdelivr.net/npm/resize-observer-polyfill@1.5.1/dist/ResizeObserver.global.js');
      if(!('queueMicrotask' in window)) window.queueMicrotask = cb => Promise.resolve().then(cb);
    })();
    </script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- TrustedForm & Jornaya placeholders (replace with your production snippets) -->
    <!-- TrustedForm (example) -->
    <script>
      // (function(){
      //   // create trusted form token input early so scripts can populate it
      //   var tf = document.createElement('input'); tf.type='hidden'; tf.id='xxTrustedFormToken'; tf.name='xxTrustedFormToken'; document.head.appendChild(tf);
      //   // load TrustedForm script (replace query params for production)
        // var s = document.createElement('script'); s.async = true; s.src = 'https://api.trustedform.com/trustedform.js?field=xxTrustedFormToken'; document.head.appendChild(s);
      // })();
    </script>
    <!-- TrustedForm -->
    <!-- <script type="text/javascript">
      (function() {
        var tf = document.createElement('script');
        tf.type = 'text/javascript';
        tf.async = true;
        tf.src = ("https:" == document.location.protocol ? 'https' : 'http') +
          '://api.trustedform.com/trustedform.js?field=xxTrustedFormCertUrl&use_tagged_consent=true&l=' +
          new Date().getTime() + Math.random();
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(tf, s);
      })();
    </script>
    <noscript>
      <img src='https://api.trustedform.com/ns.gif' />
    </noscript> -->
    <!-- End TrustedForm -->



    <!-- Jornaya / LeadiD placeholder: replace src with your snippet URL -->
    <script>
      // (function(){
      //   var s=document.createElement('script'); s.async=true; s.src='https://create.lidstatic.com/campaign/YOUR_CAMPAIGN.js?snippet_version=2'; s.id='LeadiDscript_campaign'; document.head.appendChild(s);
      // })();
    </script>
    <!-- <script id="LeadiDscript" type="text/javascript">
      (function() {
        var s = document.createElement('script');
        s.id = 'LeadiDscript_campaign';
        s.type = 'text/javascript';
        s.async = true;
        s.src = '//create.lidstatic.com/campaign/af33a750-123d-fa00-dc1b-a5e61e79d270.js?snippet_version=2';
        var LeadiDscript = document.getElementById('LeadiDscript');
        LeadiDscript.parentNode.insertBefore(s, LeadiDscript);
      })();
    </script>
    <noscript><img src='//create.leadid.com/noscript.gif?lac=7F65975C-84E7-8EEC-10A7-E77D2941A08C&lck=af33a750-123d-fa00-dc1b-a5e61e79d270&snippet_version=2' /></noscript> -->

    <style>

      :root {
        --bs-success-rgb: 5, 150, 105;
        color: #16a34a;
      }
      /* small custom tweaks */
      body { -webkit-font-smoothing:antialiased; }

      /* Page &larr; Background using the local bg.svg placed in the same folder as this page */
  html, body { height: 100%; min-height: 100svh; }
  /* Increase all Tailwind rem-based font sizes by 2px (base 16px -> 18px) */
  html { font-size: 18px; }
      body {
        background-image: url('bg.svg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: #0f2c56; /* fallback background color */
      }

      /* subtle dim overlay for better card contrast; card is elevated above it */
      #app::before {
        content: "";
        position: fixed;
        inset: 0;
        background: rgba(3, 20, 71, 0.32);
        pointer-events: none;
        z-index: 0;
      }
      /* ensure the card is above the overlay */
      #app > div { position: relative; z-index: 1; }

  /* progress bar styling */
  .progress-track { background: rgba(229,231,235,1); height: 8px; border-radius: 9999px; overflow: hidden; }
  .progress-fill { background: linear-gradient(90deg,#16a34a,#10b981); height: 100%; width: 0%; transition: width 360ms cubic-bezier(.2,.8,.2,1); }
  .progress-label { font-size: 12px; color: rgba(15,23,42,0.85); }
  .progress-track { cursor: pointer; }

  .progress { position: relative; }
  .progress-bar { transition: all 1000ms cubic-bezier(.2,.8,.2,1);}
  .progress {
    position: relative;
    overflow: visible; /* чтобы видно было то, что вылетает наружу */
  }

  .progress-highlight {
    animation: progress-highlight 1.2s ease-out;
  }

  .progress-bar {
    position: relative;
    transition: all 1000ms cubic-bezier(.2,.8,.2,1);
    overflow: visible;
    border-radius: 0.375rem 0 0 0.375rem;
  }

  .progress-highlight .progress-bar::before,
  .progress-highlight .progress-bar::after {
    content: "✦";
    position: absolute;
    right: -10px; /* из конца прогресс-бара */
    top: 50%;
    font-size: 12px;
    color: #10b981;
    opacity: 0;
    transform: translateY(-50%) scale(0);
    animation: star-fly 1.2s ease-out forwards;
    pointer-events: none;
  }

  .progress-highlight .progress-bar::after {
    animation-delay: 0.3s;
  }
  .b-rad-done { border-radius: 0.375rem !important; }

  @keyframes progress-highlight {
    0%   { box-shadow: 0 0 0px 0px rgba(16, 184, 129, 0); }
    50%  { box-shadow: 0 0 10px 6px rgba(16, 184, 129, 0.5); }
    100% { box-shadow: 0 0 0px 0px rgba(16, 184, 129, 0); }
  }

  @keyframes star-fly {
    0% {
      opacity: 0;
      transform: translate(0, -50%) scale(0);
    }
    20% {
      opacity: 1;
      transform: translate(8px, -15px) scale(1);
    }
    80% {
      opacity: 0.6;
      transform: translate(28px, -30px) scale(0.8);
    }
    100% {
      opacity: 0;
      transform: translate(45px, -45px) scale(0);
    }
  }
  /* directional sliding panels */
  .step-panel { position: relative; }
  .step-panel.from-right { transform: translateX(48px); opacity:0; }
  .step-panel.from-left { transform: translateX(-48px); opacity:0; }
  .step-panel.slide-active { transform: translateX(0); opacity:1; transition: transform .42s cubic-bezier(.4,.8,.2,1), opacity .42s; will-change: transform, opacity; }

  /* offer search loader */
  .dot-seq { display: inline-flex; gap:6px; }
  .dot-seq span { width:10px; height:10px; border-radius:50%; background:#10b981; opacity:.25; animation: pulseDots 1.2s linear infinite; }
  .dot-seq span:nth-child(2){ animation-delay:.2s; }
  .dot-seq span:nth-child(3){ animation-delay:.4s; }
  .dot-seq span:nth-child(4){ animation-delay:.6s; }
  @keyframes pulseDots { 0%,100%{ opacity:.25; transform:scale(.7);} 50%{ opacity:1; transform:scale(1);} }
  .scan-bar { position:relative; height:6px; border-radius:9999px; background:linear-gradient(90deg,#34d39922,#10b98133,#34d39922); overflow:hidden; }
  .scan-bar::before { content:""; position:absolute; inset:0; background:linear-gradient(90deg,#10b98100,#10b981,#10b98100); width:40%; animation: scan 1.4s ease-in-out infinite; filter:blur(4px); }
  @keyframes scan { 0%{ left:-40%; } 50%{ left:60%; } 100%{ left:110%; } }
  /* phase check pop */
  .phase-pop { animation: pop .4s cubic-bezier(.4,1.4,.4,1); }
  @keyframes pop { 0%{ transform:scale(.4); opacity:0; } 60%{ transform:scale(1.15); opacity:1; } 100%{ transform:scale(1); opacity:1; } }
  
  div.leading-snug { font-size: 12px!important; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="app" class="min-h-screen flex items-center justify-center px-2">
      <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg border border-slate-200">
        <div class="p-5 sm:p-6 text-center">
          <h1 v-if="step <= 4" class="text-2xl font-bold text-blue-900">Exclusive Offer!</h1>
          <h1 v-if="step > 4" class="text-2xl font-bold text-blue-900">Complete The Quiz And The Claim Reward</h1>
          <div v-if="step <= 4" class="mt-4 flex items-center justify-center gap-3">
            <div class="p-2 bg-primary/10 text-primary rounded-lg">
              <svg width="25px" height="25px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.0011 17.3498C12.9013 17.3498 13.6311 16.6201 13.6311 15.7198C13.6311 14.8196 12.9013 14.0898 12.0011 14.0898C11.1009 14.0898 10.3711 14.8196 10.3711 15.7198C10.3711 16.6201 11.1009 17.3498 12.0011 17.3498Z" fill="#292D32"/>
                <path d="M16.65 9.44H7.35C7.27 9.44 7.2 9.44 7.12 9.44V8.28C7.12 5.35 7.95 3.4 12 3.4C16.33 3.4 16.88 5.51 16.88 7.35C16.88 7.74 17.19 8.05 17.58 8.05C17.97 8.05 18.28 7.74 18.28 7.35C18.28 3.8 16.17 2 12 2C6.37 2 5.72 5.58 5.72 8.28V9.53C2.92 9.88 2 11.3 2 14.79V16.65C2 20.75 3.25 22 7.35 22H16.65C20.75 22 22 20.75 22 16.65V14.79C22 10.69 20.75 9.44 16.65 9.44ZM12 18.74C10.33 18.74 8.98 17.38 8.98 15.72C8.98 14.05 10.34 12.7 12 12.7C13.66 12.7 15.02 14.06 15.02 15.72C15.02 17.39 13.67 18.74 12 18.74Z" fill="#292D32"/>
              </svg>
            </div>
            <div class="text-left">
              <div class="text-sm font-semibold">Unlock Your Reward</div>
              <div class="text-xs text-slate-500">FREE Shipping Included</div>
            </div>
          </div>

          <div v-show="step <= 4" class="mt-6 bg-slate-50 p-4 rounded-lg border shadow-sm">
            <div class="text-sm text-slate-600">Total Amount Awarded</div>
            <div class="mt-2 text-3xl font-extrabold text-amber-600">${{ animatedAmount.toLocaleString() }}</div>
          </div>

          <!-- Progress bar (visible across steps) -->
          <div v-show="step !== 1" class="mt-4 w-full px-6">
            <div id="progress" :class="{ 'progress-highlight': progressAnimate }" class="progress" role="progressbar" :aria-valuenow="Math.round(progressPercent)" aria-valuemin="0" aria-valuemax="100">
              <div :class="{ 'b-rad-done': step === totalSteps }" class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" :aria-valuenow="Math.round(progressPercent)" aria-valuemin="0" aria-valuemax="100" :style="{ width: progressPercent + '%' }"></div>
            </div>
          </div>
        </div>

        <div class="p-5 sm:p-6 pt-0 border-t border-slate-100">
          <!-- Steps -->
          <form @submit.prevent class="space-y-4" autocomplete="on" name="reward-form">

            <input type="hidden" id="leadid_token" name="universal_leadid" value=""/>
            <input type="hidden" id="trustedform_cert_url" name="xxTrustedFormCertUrl" value=""/>
            <input type="hidden" id="trustedform_token" name="xxTrustedFormToken" value=""/>
            <input type="hidden" id="xxTrustedFormPingUrl" name="xxTrustedFormPingUrl" value=""/>

            <!-- Step 1: Email intake -->
            <div v-show="step === 1" class="step-panel" data-step="1">
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Will you be next? Enter your email so we can contact you.</h3>
              <label class="block text-sm text-slate-700">Email</label>
              <input v-model="data.email" @input="clearError('email')" type="email" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-3 text-sm" placeholder="you@example.com" autocomplete="email"/>
              <div v-if="errors.email" class="mt-1 text-xs text-rose-600">{{ errors.email }}</div>
              <div class="mt-8 flex gap-2">
                <button type="button" @click="next('email')" :disabled="!isValid('email')" :aria-disabled="!isValid('email')" 
                  :class="['flex-1 inline-flex justify-center items-center gap-2 px-4 py-3 rounded-lg bg-primary text-white', !isValid('email') ? 'opacity-50 cursor-not-allowed' : '']">Continue</button>
              </div>
              <div class="mt-3 text-xs text-slate-600 leading-snug">
                By clicking Continue, I agree to receive marketing and promotional emails from <strong>{{ domain }}</strong> and our partners. I also agree to the <a href="#" class="underline text-primary">Terms &amp; Conditions</a>, including mandatory arbitration, <a href="#" class="underline text-primary">Privacy Policy</a> and site recordation by TrustedForm and Jornaya.
              </div>
            </div>

            <!-- Step 2: Personal info -->
            <div v-show="step === 2" class="step-panel" data-step="2">
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Tell us about yourself</h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <label class="text-sm text-slate-700">
                  <div class="mb-1">First Name</div>
                  <input v-model="data.first" @input="clearError('first')" type="text" name="given-name" autocomplete="given-name" class="w-full rounded-lg border border-slate-200 px-4 py-3 text-sm" />
                  <div v-if="errors.first" class="mt-1 text-xs text-rose-600">{{ errors.first }}</div>
                </label>
                <label class="text-sm text-slate-700">
                  <div class="mb-1">Last Name</div>
                  <input v-model="data.last" @input="clearError('last')" type="text" name="family-name" autocomplete="family-name" class="w-full rounded-lg border border-slate-200 px-4 py-3 text-sm" />
                  <div v-if="errors.last" class="mt-1 text-xs text-rose-600">{{ errors.last }}</div>
                </label>
              </div>

              <div class="min-w-100 pt-2 pb-0">
                <label class="text-sm text-slate-700">Date Of Birth: &nbsp;
                <span class="font-medium text-blue-500">{{ data.dobMonth + '-' + data.dobDay + '-' + data.dobYear }}</span></label>
              </div>
              <div class="mt-3 grid grid-cols-3 gap-2">
                <!-- Month -->
                <select v-model="data.dobMonth" name="bday-month" autocomplete="bday-month" class="rounded-lg border border-slate-200 px-3 py-2 text-sm form-select">
                  <option disabled value="">Month</option>
                  <option v-for="m in months" :key="m" :value="m">{{ m }}</option>
                </select>
                <!-- Day (depends on month/year) -->
                <select v-model="data.dobDay" name="bday-day" autocomplete="bday-day" class="rounded-lg border border-slate-200 px-3 py-2 text-sm form-select">
                  <option disabled value="">Day</option>
                  <option v-for="d in days" :key="d" :value="d">{{ d }}</option>
                </select>
                <!-- Year -->
                <select v-model="data.dobYear" name="bday-year" autocomplete="bday-year" @change="clearError('dobYear')" class="rounded-lg border border-slate-200 px-3 py-2 text-sm form-select">
                  <option disabled value="">Year</option>
                  <option v-for="y in years" :key="y" :value="String(y)">{{ y }}</option>
                </select>
                <div v-if="errors.dobDay || errors.dobMonth || errors.dobYear" class="mt-1 text-xs text-rose-600 col-span-3">{{ errors.dobDay || errors.dobMonth || errors.dobYear }}</div>
              </div>

              <label class="block text-sm text-slate-700 mt-3">Gender</label>
              <select v-model="data.gender" name="gender" autocomplete="sex" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-3 text-sm form-select">
                <option value="">Prefer not to say</option>
                <option>Female</option>
                <option>Male</option>
              </select>

              <div class="mt-8 flex gap-2">
                <button type="button" @click="prev" class="rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button>
                <button type="button" @click="next('personal')" :disabled="!isValid('personal')" :aria-disabled="!isValid('personal')" :class="['flex-1 rounded-lg bg-primary text-white px-4 py-3', !isValid('personal') ? 'opacity-50 cursor-not-allowed' : '']">Continue</button>
              </div>
            </div>

            <!-- Step 3: Address with ZIP autofill (Zippopotamus free API) -->
            <div v-show="step === 3" class="step-panel" data-step="3">
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Enter your address</h3>
              <label class="block text-sm text-slate-700">Street Address:</label>
              <div class="address-autocomplete mt-1">
                <input id="street_address_input" v-model="data.street" @input="clearError('street')" type="text" name="street-address" autocomplete="street-address" class="w-full rounded-lg border border-slate-200 px-4 py-3 text-sm" placeholder="Start typing here..." />
                <div id="suggestions"></div>
              </div>
              <div v-if="errors.street" class="mt-1 text-xs text-rose-600">{{ errors.street }}</div>

              <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
                <input id="zip_code_input" v-model="data.zip" @blur="lookupZip" @input="clearError('zip')" type="text" name="postal-code" autocomplete="postal-code" placeholder="ZIP" class="rounded-lg border border-slate-200 px-4 py-3 text-sm" />
                <input id="city_input" v-model="data.city" type="text" name="address-level2" autocomplete="address-level2" placeholder="City" class="rounded-lg border border-slate-200 px-4 py-3 text-sm" />
                <input id="state_input" v-model="data.state" type="text" name="address-level1" autocomplete="address-level1" placeholder="State" class="rounded-lg border border-slate-200 px-4 py-3 text-sm" />
              </div>

              <!-- <div class="mt-2 text-xs text-slate-500">Start typing the address for autofill</div> -->

              <div class="mt-8 flex gap-2">
                <button type="button" @click="prev" class="rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button>
                <button type="button" @click="next('address')" :disabled="!isValid('address')" :aria-disabled="!isValid('address')" :class="['flex-1 rounded-lg bg-primary text-white px-4 py-3', !isValid('address') ? 'opacity-50 cursor-not-allowed' : '']">Continue</button>
              </div>
            </div>

            <!-- Step 4: Phone + TCPA -->
            <div v-show="step === 4" class="step-panel" data-step="4">
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Enter your phone number</h3>
              <label class="block text-sm text-slate-700">Phone</label>
              <input v-model="data.phone" @input="clearError('phone')" type="tel" name="tel" autocomplete="tel" placeholder="555-555-5555" class="mt-1 w-full rounded-lg border border-slate-200 px-4 py-3 text-sm" />
              <div v-if="errors.phone" class="mt-1 text-xs text-rose-600">{{ errors.phone }}</div>

              <div class="mt-3 text-xs text-slate-600 leading-snug">
                By selecting "Continue", I provide my ESIGN signature and express consent for <strong>{{ domain }}</strong>, and partners to contact me at the phone number I provided for marketing and transactional messages via text and calls,
                which may use automated, manual, prerecorded, or AI technology, until I revoke consent. This applies even if my number is on a “Do Not Call” list. Consent is not required to use this site or obtain goods/services.
                Click here to proceed without consent. I have read and agree to the Terms &amp; Conditions, including mandatory arbitration, for resolving disputes and TCPA claims.
              </div>

              <div class="mt-8 flex gap-2">
                <button type="button" @click="prev" class="rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button>
                <button type="button" @click="finalize" :disabled="!isValid('phone')" :aria-disabled="!isValid('phone')" :class="['flex-1 rounded-lg bg-primary text-white px-4 py-3', !isValid('phone') ? 'opacity-50 cursor-not-allowed' : '']">Continue</button>
              </div>
            </div>

            <!-- Step 5: Feeling lucky -->
            <div v-show="step === 5" class="step-panel" data-step="5">
              <input type="hidden" name="feeling_lucky" :value="answers.feeling_lucky || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Are you feeling lucky today?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('feeling_lucky','Yes')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Yes</button>
                <button type="button" @click="answer('feeling_lucky','No')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">No</button>
              </div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 6: Checking account -->
            <div v-show="step === 6" class="step-panel" data-step="6">
              <input type="hidden" name="checking_account" :value="answers.checking_account || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Do you have an active checking account?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('checking_account','Yes')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Yes</button>
                <button type="button" @click="answer('checking_account','No')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">No</button>
              </div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 7: Employment status -->
            <div v-show="step === 7" class="step-panel" data-step="7">
              <input type="hidden" name="employment_status" :value="answers.employment_status || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">What is your current employment status?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2 text-sm">
                <button type="button" @click="answer('employment_status','Employed')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Employed</button>
                <button type="button" @click="answer('employment_status','Unemployed')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Unemployed</button>
                <button type="button" @click="answer('employment_status','Disability')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Disability</button>
                <button type="button" @click="answer('employment_status','Retired')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Retired</button>
                <button type="button" @click="answer('employment_status','Student')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Student</button>
              </div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 8: Use reward -->
            <div v-show="step === 8" class="step-panel" data-step="8">
              <input type="hidden" name="use_reward" :value="answers.use_reward || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">How do you plan to use your reward?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('use_reward','Save It')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Save It</button>
                <button type="button" @click="answer('use_reward','Spend It')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Spend It</button>
                <button type="button" @click="answer('use_reward','Still Deciding')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Still Deciding</button>
              </div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 9: Stop sign (simple check) -->
            <div v-show="step === 9" class="step-panel" data-step="9">
              <input type="hidden" name="stop_sign" :value="answers.stop_sign || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">What color is a stop sign?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('stop_sign','Blue')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Blue</button>
                <button type="button" @click="answer('stop_sign','Yellow')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Yellow</button>
                <button type="button" @click="answer('stop_sign','Red')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Red</button>
                <button type="button" @click="answer('stop_sign','Green')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Green</button>
              </div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 10: Health Insurance -->
            <div v-show="step === 10" class="step-panel" data-step="10">
              <input type="hidden" name="health_ins" :value="answers.health_ins || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Which best describes your Health Insurance coverage? <span class="text-xs text-slate-500">(Optional)</span></h3>
              <div class="mt-3 grid grid-cols-1 gap-2 text-sm">
                <button type="button" @click="answer('health_ins','Medicare')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Medicare</button>
                <button type="button" @click="answer('health_ins','Medicaid')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Medicaid</button>
                <button type="button" @click="answer('health_ins','Medicare & Medicaid')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Medicare & Medicaid</button>
                <button type="button" @click="answer('health_ins','Insurance through work')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Insurance through work</button>
                <button type="button" @click="answer('health_ins','Marketplace or Private Insurance')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Marketplace or Private Insurance</button>
                <button type="button" @click="answer('health_ins','Uninsured')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Uninsured</button>
                <button type="button" @click="answer('health_ins','Skip')" class="w-full px-4 py-3 rounded-lg border">Skip</button>
              </div>
              <div class="mt-3 text-xs text-slate-600 leading-snug">By selecting any of the options above except "Skip," I provide my express written consent ... (consent text recorded)</div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 11: Rent or Own -->
            <div v-show="step === 11" class="step-panel" data-step="11">
              <input type="hidden" name="home_ownership" :value="answers.home_ownership || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Do you rent or own your home?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answerAndMaybeBranch('home_ownership','Rent','rent')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Rent</button>
                <button type="button" @click="answerAndMaybeBranch('home_ownership','Own','own')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Own</button>
              </div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 12: Home improvement (Own branch) -->
            <div v-show="step === 12" class="step-panel" data-step="12">
              <input type="hidden" name="home_projects" :value="JSON.stringify(answers.home_projects || [])" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Which home improvement projects are you considering? (select any)</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <label class="inline-flex items-center ml-2 p-2 border rounded border-slate-300 bg-slate-100"><input type="checkbox" @change="toggleChoice('home_projects','windows')" class="w-4 h-4 text-blue-600 bg-gray-50 border-gray-300 rounded-2xl focus:ring-blue-500"> <span class="ml-3">Windows</span></label>
                <label class="inline-flex items-center ml-2 p-2 border rounded border-slate-300 bg-slate-100"><input type="checkbox" @change="toggleChoice('home_projects','roofing')" class="w-4 h-4 text-blue-600 bg-gray-50 border-gray-300 rounded-2xl focus:ring-blue-500"> <span class="ml-3">Roofing</span></label>
                <label class="inline-flex items-center ml-2 p-2 border rounded border-slate-300 bg-slate-100"><input type="checkbox" @change="toggleChoice('home_projects','bathroom_remodel')" class="w-4 h-4 text-blue-600 bg-gray-50 border-gray-300 rounded-2xl focus:ring-blue-500"> <span class="ml-3">Bathroom remodel</span></label>
                <label class="inline-flex items-center ml-2 p-2 border rounded border-slate-300 bg-slate-100"><input type="checkbox" @change="toggleChoice('home_projects','gutter_replacement')" class="w-4 h-4 text-blue-600 bg-gray-50 border-gray-300 rounded-2xl focus:ring-blue-500"> <span class="ml-3">Gutter replacement</span></label>
                <label class="inline-flex items-center ml-2 p-2 border rounded border-slate-300 bg-slate-100"><input type="checkbox" @change="toggleChoice('home_projects','walk_in_tubs')" class="w-4 h-4 text-blue-600 bg-gray-50 border-gray-300 rounded-2xl focus:ring-blue-500"> <span class="ml-3">Walk in tubs</span></label>
                <label class="inline-flex items-center ml-2 p-2 border rounded border-slate-300 bg-slate-100"><input type="checkbox" @change="toggleChoice('home_projects','solar')" class="w-4 h-4 text-blue-600 bg-gray-50 border-gray-300 rounded-2xl focus:ring-blue-500"> <span class="ml-3">Solar</span></label>
                <label class="inline-flex items-center ml-2 p-2 border rounded border-slate-300 bg-slate-100"><input type="checkbox" @change="toggleChoice('home_projects','none')" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-2xl focus:ring-blue-500"> <span class="ml-3">None</span></label>
              </div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="rounded-lg border px-4 py-3">&larr; Back</button> -->
                <button type="button" @click="stepNext" class="flex-1 rounded-lg  bg-gray-50 bg-primary text-white px-4 py-3">Continue</button></div>
            </div>

            <!-- Step 13: Cars count (Rent branch) -->
            <div v-show="step === 13" class="step-panel" data-step="13">
              <input type="hidden" name="cars_count" :value="answers.cars_count || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">How many cars are in your household?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('cars_count','0')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">0</button>
                <button type="button" @click="answer('cars_count','1')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">1</button>
                <button type="button" @click="answer('cars_count','2')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">2</button>
                <button type="button" @click="answer('cars_count','3+')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">3+</button>
              </div>
              <input type="hidden" name="cars_count" :value="answers.cars_count || ''" />
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 14: Recent auto accident -->
            <div v-show="step === 14" class="step-panel" data-step="14">
              <input type="hidden" name="auto_accident" :value="answers.auto_accident || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Were you in an auto accident recently?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('auto_accident','Yes')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Yes</button>
                <button type="button" @click="answer('auto_accident','No')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">No</button>
              </div>
              <input type="hidden" name="auto_accident" :value="answers.auto_accident || ''" />
              <div class="mt-3 text-xs text-slate-600 leading-snug">By selecting Yes, I provide my express written consent to be contacted regarding potential motor vehicle accident assistance...</div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 15: Education -->
            <div v-show="step === 15" class="step-panel" data-step="15">
              <input type="hidden" name="education" :value="answers.education || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Are you interested in continuing your education?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('education','Yes')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Yes</button>
                <button type="button" @click="answer('education','No')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">No</button>
              </div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 16: Pain treatment -->
            <div v-show="step === 16" class="step-panel" data-step="16">
              <input type="hidden" name="pain_treatment" :value="answers.pain_treatment || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Struggling With Pain? Make Under $40k & on Medicaid? Powerful Treatment Available!</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('pain_treatment','Yes')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Yes</button>
                <button type="button" @click="answer('pain_treatment','No')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">No</button>
              </div>
              <div class="mt-3 text-xs text-slate-600">*AGREEMENT TO BE CONTACTED: By selecting "YES" ... (consent text)</div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 17: Prescription meds 7+ -->
            <div v-show="step === 17" class="step-panel" data-step="17">
              <input type="hidden" name="meds_7plus" :value="answers.meds_7plus || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Do you take 7 or more prescription medications?</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('meds_7plus','Yes')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">Yes</button>
                <button type="button" @click="answer('meds_7plus','No')" class="w-full px-4 py-3 rounded-lg border bg-blue-500 text-white">No</button></div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
              </div>
            </div>

            <!-- Step 18: Veterans -->
            <div v-show="step === 18" class="step-panel" data-step="18">
              <input type="hidden" name="veterans" :value="answers.veterans || ''" />
              <h3 class="mb-4 text-lg font-semibold text-blue-900 text-center">Veterans: Get Up to $3,600/mo Tax-Free — See if you qualify</h3>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <button type="button" @click="answer('veterans','Check'); finalize()" class="w-full px-4 py-3 rounded-lg border bg-emerald-500 text-white">Check Eligibility</button></div>
              <div class="mt-8 flex gap-2">
                <!-- <button type="button" @click="prev" class="flex-1 rounded-lg bg-gray-50 border px-4 py-3">&larr; Back</button> -->
                <button type="button" @click="finalize" class="flex-1 rounded-lg bg-primary text-white px-4 py-3">Finish</button>
              </div>
            </div>

            <!-- Step 19: Offer matching animation -->
            <div v-show="step === 19" class="step-panel" data-step="19">
              <div v-if="!offerMatchComplete" class="space-y-6">
                <div>
                  <div class="text-lg font-semibold text-slate-800">Matching offers for you</div>
                  <div class="mt-1 text-sm text-slate-500">Securely processing your responses...</div>
                </div>
                <div class="scan-bar"></div>
                <div class="flex items-center gap-3">
                  <div class="dot-seq"><span></span><span></span><span></span><span></span></div>
                  <div class="text-sm text-emerald-600 font-medium" v-text="offerPhaseText"></div>
                </div>
                <ul class="text-xs space-y-2">
                  <li v-for="(p,i) in phaseList" :key="i" class="flex items-start gap-2">
                    <span class="inline-flex items-center justify-center w-5 h-5 mt-0.5 rounded-full border text-[10px] font-medium"
                          :class="completedPhases>i ? 'bg-emerald-500 border-emerald-500 text-white phase-pop' : (activePhase===i ? 'border-emerald-400 text-emerald-500 animate-pulse' : 'border-slate-300 text-slate-400')">
                      <template v-if="completedPhases>i">✔</template>
                      <template v-else>{{ i+1 }}</template>
                    </span>
                    <span :class="completedPhases>i ? 'text-emerald-600' : (activePhase===i ? 'text-emerald-500' : 'text-slate-500')">{{ phaseLabel(i) }}</span>
                  </li>
                </ul>
              </div>
              <div v-else class="space-y-5 text-center">
                <div class="mx-auto w-20 h-20 rounded-full bg-emerald-100 flex items-center justify-center">
                  <svg width="54" height="54" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
                </div>
                <h2 class="text-xl font-bold text-emerald-700">Success!</h2>
                <p class="text-sm text-slate-600 leading-relaxed">We have successfully matched your profile with active reward opportunities. Our team will contact you shortly. Please keep your phone available.</p>
                <button type="button" @click="resetFlow" class="w-full rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-3 text-sm font-medium transition">Start Over</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
      const progressBar = document.querySelector('#progress');

      const { createApp, ref, watch } = Vue;
      createApp({
        data() { return {
          step: 1,
          startAmount: 1000000,
          targetAmount: 1450000,
          animatedAmount: 1000000,
          domain: window.location.hostname || 'DOMAIN',
          totalSteps: 19,
          data: { email:'', first:'', last:'', dobMonth:'', dobDay:'', dobYear:'', gender:'', street:'', zip:'', city:'', state:'', phone:'' },
          errors: {},
          answers: {},
          services: { jornaya_leadid: '', trustedform_cert_url: '', trustedform_token: '', xxTrustedFormPingUrl: '' },
          direction: 1,
          offerMatchComplete: false,
          phaseIndex: 0,
          offerPhaseText: '',
          phaseList: ['Validating eligibility','Prioritizing partner rewards','Finalizing reserved spots'],
          completedPhases: 0,
          activePhase: 0,
          matcherTimer: null,
          progressValue: 0,
          progressAnimate: false,
        }; },
        watch: {
          step(newVal, oldVal) {
            this.progressAnimate = false;
            if (oldVal != null) this.direction = newVal > oldVal ? 1 : -1;
            this.$nextTick(()=>{
              const panel = this.$el.querySelector('[data-step="'+newVal+'"]');
              if (!panel) return;
              panel.classList.remove('from-right','from-left','slide-active');
              panel.classList.add(this.direction === 1 ? 'from-right' : 'from-left');
              requestAnimationFrame(()=>{
                panel.classList.add('slide-active');
                this.progressAnimate = true;
                setTimeout(()=>{ 
                  panel.classList.remove('from-right','from-left'); 
                }, 480);
              });
            });
          }
        },
        computed: {
          progressPercent() {
            this.progressValue = Math.min(100, Math.max(0, ((this.step - 1) / (this.totalSteps - 1)) * 100));
            return this.progressValue;
          },
          // full month labels (short form to stay compact in select)
          months() { return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; },
          years() {
            const current = new Date().getFullYear();
            return Array.from({length: 100}, (_,i)=> current - i); // last 100 years
          },
          days() {
            const monthIdx = this.months.indexOf(this.data.dobMonth);
            if (monthIdx === -1) return Array.from({length:31},(_,i)=> String(i+1).padStart(2,'0'));
            const yearNum = parseInt(this.data.dobYear,10) || new Date().getFullYear();
            const lastDay = new Date(yearNum, monthIdx + 1, 0).getDate();
            // if selected day exceeds new month length, clear it (no mutation inside computed ideally, so handle outside if desired)
            if (this.data.dobDay && parseInt(this.data.dobDay,10) > lastDay) {
              // defer clearing to microtask to avoid mutating during compute
              queueMicrotask(()=>{ if (parseInt(this.data.dobDay,10) > lastDay) this.data.dobDay=''; });
            }
            return Array.from({length:lastDay},(_,i)=> String(i+1).padStart(2,'0'));
          }
        },
        mounted() {
          this.animateAmount();
          this.$nextTick(()=>{
            const first = this.$el.querySelector('[data-step="1"]');
            if (first) first.classList.add('slide-active');
          });
        },
        methods: {
          animateAmount() {
            const duration = 3000; // ms
            const start = performance.now();
            const from = this.startAmount; const to = this.targetAmount;
            // exponential deceleration (easeOutExpo) — tuned to be a bit slower at the start
            const easeOutExpo = (t) => {
              if (t >= 1) return 1;
              // smaller multiplier -> slower early progress (keeps total duration the same)
              const multiplier = 5; // tuned down slightly for a gentler start
              return 1 - Math.pow(2, -multiplier * t);
            };
            const step = (now) => {
              const raw = Math.min(1, (now - start) / duration);
              const eased = easeOutExpo(raw);
              this.animatedAmount = Math.floor(from + (to - from) * eased);
              if (raw < 1) {
                requestAnimationFrame(step);
              } else {
                // ensure we end exactly at target
                this.animatedAmount = to;
              }
            };
            requestAnimationFrame(step);
          },
          // centralized validation: returns true when stage is valid
          validate(stage) {
            // reset errors for a fresh validation run
            this.errors = {};
            if (stage === 'email') {
              if (!this.data.email || !this.data.email.includes('@')) {
                this.errors.email = 'Enter a valid email address';
                return false;
              }
            }
            if (stage === 'personal') {
              if (!this.data.first) { this.errors.first = 'First name is required'; }
              if (!this.data.last) { this.errors.last = 'Last name is required'; }
              if (!this.data.dobYear) { this.errors.dobYear = 'Please select your birth year'; }
              if (!this.data.dobMonth) { this.errors.dobMonth = 'Please select your birth month'; }
              if (!this.data.dobDay) { this.errors.dobDay = 'Please select your birth day'; }
              if (Object.keys(this.errors).length) return false;
            }
            if (stage === 'address') {
              if (!this.data.street) { this.errors.street = 'Street address is required'; return false; }
              if (!this.data.city) { this.errors.city = 'City is required'; return false; }
              if (!this.data.state) { this.errors.state = 'State is required'; return false; }
              if (!this.data.zip || this.data.zip.length < 5) { this.errors.zip = 'ZIP code is required'; return false; }
            }
            return true;
          },

          // non-mutating mirror used for button disabled state checks
          validateForCheck(stage) {
            const errs = {};
            if (stage === 'email') {
              const e = String(this.data.email || '').trim();
              // lightweight email regex: local@domain.tld (covers common cases, not fully RFC5322)
              const emailOk = e.length > 4 && e.length <= 254 && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
              if (!emailOk) { errs.email = true; }
            }
            if (stage === 'personal') {
              if (!this.data.first) { errs.first = true; }
              if (!this.data.last) { errs.last = true; }
              if (!this.data.dobYear) { errs.dobYear = true; }
              if (!this.data.dobMonth) { errs.dobMonth = true; }
              if (!this.data.dobDay) { errs.dobDay = true; }
            }
            if (stage === 'address') {
              if (!this.data.street) { errs.street = true; }
            }
            if (stage === 'phone') {
              if (!this.data.phone) { errs.phone = true; }
            }
            return Object.keys(errs).length === 0;
          },

          isValid(stage) {
            // quick, non-destructive check used by button disabled binding
            return this.validateForCheck(stage);
          },

          // validate then advance for early intake steps (replaces nextIf)
          next(stage) {
            if (!this.validate(stage)) return;
            // original flow only advanced through the first intake steps
            if (this.step < 4) this.step++;
          },
          answer(key,val,nextStep) {
            // store simple answers and advance; optional nextStep overrides auto-advance
            // Vue 3: use plain assignment on reactive objects
            this.answers[key] = val;
            if (typeof nextStep === 'number') {
              this.step = nextStep;
              return;
            }
            if (this.step < this.totalSteps) this.step++;
          },
          answerAndMaybeBranch(key,val,branch,nextStep) {
            this.answers[key] = val;
            // Updated branch logic (after step reordering):
            // Own -> home_projects (step 12)
            // Rent -> cars_count (step 13)
            if (branch === 'own') { this.step = 12; return; }
            if (branch === 'rent') { this.step = 13; return; }
            if (typeof nextStep === 'number') { this.step = nextStep; return; }
            if (this.step < this.totalSteps) this.step++;
          },
          toggleChoice(key,val) {
            this.answers[key] = this.answers[key] || [];
            const idx = this.answers[key].indexOf(val);
            if (idx === -1) this.answers[key].push(val); else this.answers[key].splice(idx,1);
          },
          // simple increment used by quiz steps (renamed to avoid collision with next(stage))
          stepNext() { if (this.step < this.totalSteps) this.step++; },
          prev() { if (this.step > 1) this.step--; },
          clearError(field) { if (this.errors && this.errors[field]) { delete this.errors[field]; } },
          goto(n) { const v = Number(n); if (!isNaN(v) && v >= 1 && v <= this.totalSteps) this.step = v; },
          gotoByClick(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left; const w = rect.width;
            const pct = Math.max(0, Math.min(1, x / w));
            // map percentage to steps (1..totalSteps)
            const stepIndex = Math.round(pct * (this.totalSteps - 1)) + 1;
            this.goto(stepIndex);
          },
          lookupZip() {
            const zip = String(this.data.zip||'').trim();
            if (!/^[0-9]{5}$/.test(zip)) return;
            fetch('https://api.zippopotam.us/us/' + zip).then(r=>{
              if (!r.ok) throw new Error('no'); return r.json();
            }).then(json=>{
              if (json.places && json.places.length) {
                this.data.city = json.places[0]['place name'];
                this.data.state = json.places[0]['state abbreviation'] || json.places[0]['state'];
              }
            }).catch(()=>{});
          },
          finalize() {
            this.errors = {};
            // Only enforce phone validation when still on phone intake step
            if (this.step === 4 && !this.data.phone) { this.errors.phone = 'Please enter a phone number'; return; }
            // Attempt to record TrustedForm/Jornaya tokens (inputs/scripts added in head)
            const tokenEl = document.getElementById('xxTrustedFormToken');
            const trustedFormToken = tokenEl && tokenEl.value ? tokenEl.value : null;
            // fire any Jornaya call&larr; Backs if available (placeholder)
            if (window.LeadiD && typeof window.LeadiD === 'function') {
              try { window.LeadiD('submit'); } catch(e){}
            }

            // Here you would post to server; we'll console.log and show a confirmation
            console.log('Collected data:', this.data, { trustedFormToken });
            const el = document.createElement('div'); el.textContent = 'Thanks — proceeding...';
            el.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-4 py-2 rounded-md shadow';
            document.body.appendChild(el);

            // If this finalize call came from the phone step, advance into the quiz/questions
            if (this.step === 4) {
              // remove toast then advance to step 5
              setTimeout(() => {
                try { document.body.removeChild(el); } catch(e){}
                this.step = 5;
              }, 800);
              return;
            }

            // Otherwise (final submission), transition into offer matching animation step
            setTimeout(()=>{ try{ document.body.removeChild(el); }catch(e){} }, 600);
            this.startOfferMatch();
          },
          startOfferMatch() {
            // clear any existing timers
            if (this.matcherTimer) { clearTimeout(this.matcherTimer); this.matcherTimer = null; }
            this.step = 19;
            this.offerMatchComplete = false;
            this.phaseIndex = 0;
            this.completedPhases = 0;
            this.activePhase = 0;
            const phases = [
              { t: 'Validating eligibility...', dur: 1100 },
              { t: 'Scanning partner inventory...', dur: 1100 },
              { t: 'Securing top matches...', dur: 1100 }
            ];
            const runPhase = () => {
              if (this.phaseIndex >= phases.length) {
                this.offerPhaseText = 'Completed';
                this.completedPhases = phases.length;
                this.activePhase = -1;
                this.matcherTimer = setTimeout(()=>{ this.offerMatchComplete = true; }, 600);
                return;
              }
              const current = phases[this.phaseIndex];
              this.offerPhaseText = current.t;
              this.activePhase = this.phaseIndex;
              // mark completed after a slight delay inside the phase to visualize progress
              this.matcherTimer = setTimeout(()=>{
                this.completedPhases = this.phaseIndex + 1;
                this.phaseIndex++;
                runPhase();
              }, current.dur);
            };
            runPhase();
          },
          phaseLabel(i) {
            if (this.completedPhases > i) return this.phaseList[i] + ' — done';
            if (this.activePhase === i) return this.phaseList[i] + ' — in progress';
            return this.phaseList[i] + ' — pending';
          },
          resetFlow() {
            this.step = 1;
            this.answers = {};
            this.offerMatchComplete = false;
            this.phaseIndex = 0;
            this.offerPhaseText = '';
            this.completedPhases = 0;
            this.activePhase = 0;
            if (this.matcherTimer) { clearTimeout(this.matcherTimer); this.matcherTimer = null; }
          }
        }
      }).mount('#app');
    </script>

      <script>
        // Lightweight address autocomplete using HERE autosuggest.
        (function(){
          const addressInput = document.getElementById('street_address_input');
          const suggestionsDiv = document.getElementById('suggestions');
          if (!addressInput || !suggestionsDiv) return;

          let timeoutId;
          let suppressNextInput = false; // when true, the next input event from the street field is ignored
          const CENTER_AT = '39.8283,-98.5795';
          const API_KEY = 'O8ALlQCBXm0LWDjJfADr-y-WQLlt47V98hNDgo0mZYI';

          function dispatchInput(el){
            // ensure Vue v-model picks up programmatic value changes
            el.dispatchEvent(new Event('input', { bubbles: true }));
          }

          addressInput.addEventListener('input', function(){
            // If we programmatically set the value after selecting a suggestion,
            // ignore the next input event to avoid re-querying the API.
            if (suppressNextInput) { suppressNextInput = false; suggestionsDiv.style.display = 'none'; return; }
            const query = this.value.trim();
            if (query.length < 1) {
              suggestionsDiv.innerHTML = '';
              suggestionsDiv.style.display = 'none';
              return;
            }
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
              const url = new URL('https://autosuggest.search.hereapi.com/v1/autosuggest');
              url.search = new URLSearchParams({ apiKey: API_KEY, q: query, at: CENTER_AT, in: 'countryCode:USA', limit: 7, show: 'details' });
              fetch(url).then(r=>r.json()).then(data=>{
                suggestionsDiv.innerHTML = '';
                if (!data || !data.items || data.items.length === 0) {
                  suggestionsDiv.innerHTML = '<div class="text-xs text-slate-500 p-2">No suggestions found.</div>';
                  suggestionsDiv.style.display = 'block';
                  return;
                }
                suggestionsDiv.style.display = 'block';
                data.items.forEach(item=>{
                  const div = document.createElement('div');
                  div.className = 'autocomplete-suggestion';
                  const label = item.address && item.address.label ? item.address.label : (item.title || item.id || '');
                  div.innerHTML = '<div>' + label + '</div>' + (item.address && item.address.city ? ('<small>'+ (item.address.city || '') + (item.address.stateCode ? (', ' + item.address.stateCode) : '') + '</small>') : '');
                  div.addEventListener('click', ()=>{
                    // populate fields with the best available parts
                    const house = (item.address && item.address.houseNumber) ? item.address.houseNumber + ' ' : '';
                    const street = item.address && item.address.street ? item.address.street : (item.title || '');
                    const city = item.address && item.address.city ? item.address.city : '';
                    const state = item.address && item.address.stateCode ? item.address.stateCode : (item.address && item.address.state ? item.address.state : '');
                    const postal = item.address && item.address.postalCode ? String(item.address.postalCode).split('-')[0] : '';

                    addressInput.value = (house + street).trim();
                    const cityEl = document.getElementById('city_input');
                    const stateEl = document.getElementById('state_input');
                    const zipEl = document.getElementById('zip_code_input');
                    if (cityEl) { cityEl.value = city; dispatchInput(cityEl); }
                    if (stateEl) { stateEl.value = state; dispatchInput(stateEl); }
                    if (zipEl) { zipEl.value = postal; dispatchInput(zipEl); }
                    // update Vue-bound street via input dispatch
                    // suppress the immediate input handler run triggered by this dispatch
                    suppressNextInput = true;
                    dispatchInput(addressInput);
                    suggestionsDiv.innerHTML = '';
                    suggestionsDiv.style.display = 'none';
                  });
                  suggestionsDiv.appendChild(div);
                });
              }).catch(err=>{
                console.warn('Autocomplete error', err);
              });
            }, 600);
          });
        // hide suggestions when clicking outside
        document.addEventListener('click', (e)=>{ if (!suggestionsDiv.contains(e.target) && e.target !== addressInput) { suggestionsDiv.innerHTML=''; suggestionsDiv.style.display='none'; } });
        })();
      </script>
  </body>
</html>
